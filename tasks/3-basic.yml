---
# Installing updates & configuring SSHD / hostname.
- name: 'aptitude safe-upgrade all packages'
  apt: upgrade=safe update_cache=yes force=yes

# This equals
#  shell: sed -i 's/^Port [0-9]*/Port '{{ sshd_port }}'/' /etc/ssh/sshd_config
#  shell: sed -i 's/PermitRootLogin yes/PermitRootLogin no/' /etc/ssh/sshd_config
- name: 'Reconfigure sshd - change port and disable root login'
  replace:
    dest: /etc/ssh/sshd_config
    regexp: "{{ item.regexp }}"
    replace: "{{ item.replace }}"
  with_items:
    - {
        regexp: "^Port",
        replace: "Port {{ sshd_port }}"
      }
    - {
        regexp: "^PermitRootLogin",
        replace: "PermitRootLogin no"
      }

- name: 'Restart ssh service to apply changes'
  service: name=ssh state=restarted

- name: 'Set FQDN'
  replace:
    dest: /etc/hosts
    regexp: "{{ ansible_default_ipv4.address }}.*"
    replace: "{{ ansible_default_ipv4.address }} {{ hostname_fqdn }} {{ hostname }}"

- name: 'Set Hostname'
  hostname: name="{{ hostname }}"

- name: 'Restart hostname service to apply changes'
  service: name=hostname state=restarted

# This equals
#  shell: sed -i 's/^#net.ipv4.conf.all.accept_source_route = 0/net.ipv4.conf.all.accept_source_route = 0/' /etc/sysctl.conf
#  shell: sed -i 's/^net.ipv4.conf.all.accept_source_route = 1/net.ipv4.conf.all.accept_source_route = 0/' /etc/sysctl.conf
#  shell: sed -i 's/^#net.ipv6.conf.all.accept_source_route = 0/net.ipv6.conf.all.accept_source_route = 0/' /etc/sysctl.conf
#  shell: sed -i 's/^net.ipv6.conf.all.accept_source_route = 1/net.ipv6.conf.all.accept_source_route = 0/' /etc/sysctl.conf
- name: 'Basic hardening of sysctl.conf'
  replace:
    dest: /etc/sysctl.conf
    regexp: "{{ item.regexp }}"
    replace: "{{ item.replace }}"
  with_items:
    - {
        regexp: "^#net.ipv4.conf.all.accept_source_route = 0",
        replace: "net.ipv4.conf.all.accept_source_route = 0"
      }
    - {
        regexp: "^net.ipv4.conf.all.accept_source_route = 1",
        replace: "net.ipv4.conf.all.accept_source_route = 0"
      }
    - {
        regexp: "^#net.ipv6.conf.all.accept_source_route = 0",
        replace: "net.ipv6.conf.all.accept_source_route = 0"
      }
    - {
        regexp: "^net.ipv6.conf.all.accept_source_route = 1",
        replace: "net.ipv6.conf.all.accept_source_route = 0"
      }